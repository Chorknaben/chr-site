// Generated by CoffeeScript 1.7.1
var Tile,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Tile = (function() {
  function Tile(_const) {
    this["const"] = _const;
    this.finalizeLoading = __bind(this.finalizeLoading, this);
    this.load = __bind(this.load, this);
    this.core = window.core;
    this.interval = null;
    this.scaleCount = 0;
    this.headerImg = $("#header-img");
    this.core.exportFunction("Tile.finalizeLoading", this.finalizeLoading);
    this.core.exportFunction("Tile.load", this.load);
  }

  Tile.prototype.load = function(urlWhat, animate, callback, originalSite, urlOverride, bare) {
    if (animate == null) {
      animate = false;
    }
    if (originalSite == null) {
      originalSite = void 0;
    }
    if (urlOverride == null) {
      urlOverride = void 0;
    }
    if (bare == null) {
      bare = false;
    }
    if (!bare) {
      window.nav.by(this["const"].METHODS.NAME_USER, urlWhat);
    }
    this.core.state["globalHashResponseDisabled"] = true;
    return $("#result").load("content/" + urlWhat + ".html", (function(_this) {
      return function() {
        if (animate) {
          _this.setLoadingScreen(true);
        }
        $(_this.core.state["blurredbg"]).appendTo("#blurbg");
        if (!originalSite) {
          $(".scrolled").attr("id", urlWhat);
        } else {
          $(".scrolled").attr("id", originalSite);
        }
        if (!urlOverride) {
          _this.core.state["currentURL"] = urlWhat;
        } else {
          _this.core.state["currentURL"] = urlOverride;
        }
        _this.core.state["tileid"] = _this.tileid;
        _this.core.registerTaker("pageChanged", true);
        return $.when($.getScript("content/" + urlWhat + ".js", $.Deferred(function(deferred) {
          return $(deferred.resolve);
        }))).done(function() {
          _this.core.state["childPage"].onLoad();
          if (_this.core.state["childPage"].acquireLoadingLock()) {
            console.log("here");
            console.log(_this.core.state["childPage"]);
            _this.core.registerTaker("pendingCallback", callback);
            return;
          }
          return _this.finalizeLoading(callback, animate);
        });
      };
    })(this));
  };

  Tile.prototype.finalizeLoading = function(callback, animate) {
    var moreHash;
    if (callback == null) {
      callback = void 0;
    }
    if (animate == null) {
      animate = true;
    }
    moreHash = this.core.requestTaker("backupHash");
    if (typeof moreHash !== "undefined") {
      window.location.hash = moreHash;
    }
    if (animate) {
      this.setLoadingScreen(false);
    } else {
      $(".tilecontainer").css({
        display: "none"
      });
      this.core.state["childPage"].onDOMVisible();
    }
    $("#result").css({
      display: "block"
    });
    this.core.state["globalHashResponseDisabled"] = false;
    if (callback) {
      return callback();
    }
  };

  Tile.prototype.setLoadingScreen = function(toggle) {
    if (toggle) {
      $("#bg").css({
        opacity: 0
      });
      $(".tilecontainer").css({
        opacity: 0
      });
      return setTimeout((function(_this) {
        return function() {
          return _this.animationEnded = true;
        };
      })(this), 400);
    } else {
      if (!this.animationEnded) {
        setTimeout((function(_this) {
          return function() {
            return _this.setLoadingScreen(false);
          };
        })(this), 50);
        return;
      }
      $(".rootnode").css({
        opacity: 1
      });
      $("#loading-screen").css({
        opacity: 0
      });
      this.core.state["childPage"].onDOMVisible();
      return setTimeout(function() {
        return $("#loading-screen").css({
          display: "none"
        }, 200);
      });
    }
  };

  return Tile;

})();
